(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{628:function(t,e,s){"use strict";s.r(e);var a=s(17),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"foreword"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#foreword"}},[t._v("#")]),t._v(" Foreword")]),t._v(" "),s("p",[t._v("The code for the "),s("code",[t._v("before mutation")]),t._v(" phase is very short, the whole process is to traversal through the "),s("code",[t._v("effectList")]),t._v(" and call the "),s("code",[t._v("commitBeforeMutationEffects")]),t._v(" function to process it.")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2104-L2127",target:"_blank",rel:"noopener noreferrer"}},[t._v("You can find the complete source code from here, we have deleted some unrelated logic for better understanding."),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Save the previous priority, execute at synchronous priority, and restore the previous priority when execution is complete")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" previousLanePriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCurrentUpdateLanePriority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCurrentUpdateLanePriority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SyncLanePriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Mark the current context as CommitContext, as a flag for the commit phase")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevExecutionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" executionContext\nexecutionContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" CommitContext\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle the focus state")]),t._v("\nfocusedInstanceHandle "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepareForCommit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("containerInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nshouldFireAfterActiveInstanceBlur "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The main function of the beforeMutation phase")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitBeforeMutationEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nfocusedInstanceHandle "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n")])])]),s("p",[t._v("We will focus on the main fucntion "),s("code",[t._v("commitBeforeMutationEffects")]),t._v(" from the "),s("code",[t._v("beforeMutation")]),t._v(".")]),t._v(" "),s("h2",{attrs:{id:"commitbeforemutationeffects"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#commitbeforemutationeffects"}},[t._v("#")]),t._v(" commitBeforeMutationEffects")]),t._v(" "),s("p",[t._v("We could start talking about it with the code")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitBeforeMutationEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alternate\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("shouldFireAfterActiveInstanceBlur "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" focusedInstanceHandle "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...focus blur")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" effectTag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("effectTag\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// call getSnapshotBeforeUpdate")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("effectTag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" Snapshot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commitBeforeMutationEffectOnFiber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// schedule useEffect")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("effectTag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" Passive"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rootDoesHavePassiveEffects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        rootDoesHavePassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NormalSchedulerPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    nextEffect "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextEffect\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("We could divide into three parts.")]),t._v(" "),s("ul",[s("li",[t._v("Deal with the "),s("code",[t._v("autoFocus")]),t._v(", "),s("code",[t._v("blur")]),t._v(" logic after "),s("code",[t._v("DOM node")]),t._v(" rendered or deleted.")]),t._v(" "),s("li",[t._v("Call the lefecycle hooks of "),s("code",[t._v("getSnapshotBeforeUpdate")]),t._v(".")]),t._v(" "),s("li",[t._v("Schedule "),s("code",[t._v("useEffect")]),t._v(".")])]),t._v(" "),s("p",[t._v("We will discuss the last two parts.")]),t._v(" "),s("h2",{attrs:{id:"call-getsnapshotbeforeupdate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#call-getsnapshotbeforeupdate"}},[t._v("#")]),t._v(" Call getSnapshotBeforeUpdate")]),t._v(" "),s("p",[s("code",[t._v("commitBeforeMutationEffectOnFiber")]),t._v(", is also known as "),s("code",[t._v("commitBeforeMutationLifeCycles")]),t._v(".")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L222",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("getSnapshotBeforeUpdate")]),t._v(" will be call in the method."),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("Since React v16, the "),s("code",[t._v("UNSAFE_ prefix")]),t._v(" has been added before the "),s("code",[t._v("componentWillXXX")]),t._v(" hook.")]),t._v(" "),s("p",[t._v("The reason of it is because after the "),s("code",[t._v("Stack Reconciler")]),t._v(" is refactored to "),s("code",[t._v("Fiber Reconciler")]),t._v(", the tasks in the "),s("code",[t._v("render")]),t._v(" phase may be interrupted or restarted, and the corresponding component's lifecycle hook (i.e. "),s("code",[t._v("componentWillXXX")]),t._v(") in the "),s("code",[t._v("render")]),t._v(" phase may be triggered multiple times.")]),t._v(" "),s("p",[t._v("This behaviour is different with React v15, so we add "),s("code",[t._v("UNSAFE_")]),t._v(" to mark it.")]),t._v(" "),s("p",[t._v("For solve this problem, "),s("code",[t._v("React")]),t._v(" provides the alternative lifecycle hook "),s("code",[t._v("getSnapshotBeforeUpdate")]),t._v(".")]),t._v(" "),s("p",[t._v("We can see that "),s("code",[t._v("getSnapshotBeforeUpdate")]),t._v(" is called in the "),s("code",[t._v("before mutation")]),t._v(" phase within the "),s("code",[t._v("commit")]),t._v(" phase, and because the commit phase is "),s("code",[t._v("synchronized")]),t._v(", the multiple calls problem will be sloved.")]),t._v(" "),s("h2",{attrs:{id:"schedule-useeffect"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#schedule-useeffect"}},[t._v("#")]),t._v(" Schedule "),s("code",[t._v("useEffect")])]),t._v(" "),s("p",[t._v("Within these lines of code, the "),s("code",[t._v("scheduleCallback")]),t._v(" method is provided by the "),s("code",[t._v("Scheduler")]),t._v(" module to asynchronously schedule a callback function at a certain priority.")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// schedule useEffect")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("effectTag "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" Passive"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoEffect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rootDoesHavePassiveEffects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    rootDoesHavePassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NormalSchedulerPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// trigger useEffect")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("flushPassiveEffects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("We could find out that the callback function that is dispatched asynchronously is the method "),s("code",[t._v("flushPassiveEffects")]),t._v(" that triggers "),s("code",[t._v("useEffect")]),t._v(".")]),t._v(" "),s("p",[t._v("We will discuss how "),s("code",[t._v("useEffects")]),t._v(" are dispatched asynchronously rather than synchronously and why they are dispatched asynchronously.")]),t._v(" "),s("h3",{attrs:{id:"how-to-dispatch-asynchronously"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#how-to-dispatch-asynchronously"}},[t._v("#")]),t._v(" How to dispatch asynchronously")]),t._v(" "),s("p",[t._v("Inside the "),s("code",[t._v("flushPassiveEffects")]),t._v(" method, the "),s("code",[t._v("effectList")]),t._v(" is obtained from the global variable "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(".")]),t._v(" "),s("p",[t._v("From the previous section, we have talked about "),s("code",[t._v("effectList")]),t._v(" store the "),s("code",[t._v("Fiber node")]),t._v(" which need execute the side effect, includes")]),t._v(" "),s("ul",[s("li",[t._v("Placement")]),t._v(" "),s("li",[t._v("Update")]),t._v(" "),s("li",[t._v("Deletion")])]),t._v(" "),s("p",[t._v("Except these, the corresponding "),s("code",[t._v("Fiber node")]),t._v(" of a "),s("code",[t._v("FunctionCopoment")]),t._v(" will be assign the value "),s("code",[t._v("effectTag")]),t._v(" when it has "),s("code",[t._v("useEffect")]),t._v(" or "),s("code",[t._v("useLayoutEffect")]),t._v(".")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactHookEffectTags.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("You can check the effectTag here"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("In the "),s("code",[t._v("flushPassiveEffects")]),t._v(" method, it traversal through the "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(" (i.e. "),s("code",[t._v("effectList")]),t._v(") to execute the "),s("code",[t._v("effect")]),t._v(" callback function.")]),t._v(" "),s("p",[t._v("If executed directly at this point, "),s("code",[t._v("rootWithPendingPassiveEffects === null")]),t._v(".")]),t._v(" "),s("p",[t._v("So when will "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(" be assigned a value?")]),t._v(" "),s("p",[t._v("The code snippet after the "),s("code",[t._v("layout")]),t._v(" in the previous section will decide whether to assign "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(" based on "),s("code",[t._v("rootDoesHavePassiveEffects === true?")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rootDidHavePassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rootDoesHavePassiveEffects\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootDoesHavePassiveEffects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  rootDoesHavePassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  rootWithPendingPassiveEffects "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root\n  pendingPassiveEffectsLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" lanes\n  pendingPassiveEffectsRenderPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" renderPriorityLevel\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("So, the whole "),s("code",[t._v("useEffect")]),t._v(" asynchronous call is divided into three steps")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("before mutation")]),t._v(" stage, schedule "),s("code",[t._v("flushPassiveEffects")]),t._v(" in "),s("code",[t._v("scheduleCallback")]),t._v(".")]),t._v(" "),s("li",[t._v("assign "),s("code",[t._v("effectList")]),t._v(" to "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(" after "),s("code",[t._v("layout")]),t._v(".")]),t._v(" "),s("li",[s("code",[t._v("scheduleCallback")]),t._v(" triggers "),s("code",[t._v("flushPassiveEffects")]),t._v(", traversal "),s("code",[t._v("rootWithPendingPassiveEffects")]),t._v(" within "),s("code",[t._v("flushPassiveEffects")]),t._v(".")])]),t._v(" "),s("h3",{attrs:{id:"why-do-we-need-asynchronous"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#why-do-we-need-asynchronous"}},[t._v("#")]),t._v(" Why do we need asynchronous")]),t._v(" "),s("blockquote",[s("p",[t._v("Unlike "),s("code",[t._v("componentDidMount")]),t._v(" and "),s("code",[t._v("componentDidUpdate")]),t._v(", the function passed to "),s("code",[t._v("useEffect")]),t._v(" fires "),s("strong",[t._v("after")]),t._v(" layout and paint, during a deferred event. This makes it suitable for the many common side effects, like setting up subscriptions and event handlers, because most types of work shouldn’t block the browser from updating the screen.")])]),t._v(" "),s("p",[t._v("As you can see, the reason for asynchronous execution of "),s("code",[t._v("useEffect")]),t._v(" is to prevent synchronous execution from blocking browser rendering.")])])}),[],!1,null,null,null);e.default=n.exports}}]);