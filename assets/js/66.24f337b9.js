(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{650:function(e,t,a){"use strict";a.r(t);var s=a(17),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"key-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#key-nodes"}},[e._v("#")]),e._v(" Key Nodes")]),e._v(" "),a("p",[e._v("Before we jump into this section, we could start to know the key nodes from the source code, those calls of the key function.")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("Begining of the render stage")]),e._v(" "),a("p",[e._v("As we talked in the previous "),a("code",[e._v("render")]),e._v(" stage, we know that "),a("code",[e._v("render stage")]),e._v(" start with the "),a("code",[e._v("performSyncWorkOnRoot")]),e._v(" or "),a("code",[e._v("performConcurrentWorkOnRoot")]),e._v(" based on the type of the update.")])]),e._v(" "),a("li",[a("p",[e._v("Begining of the commit stage")]),e._v(" "),a("p",[a("code",[e._v("commit")]),e._v(" stage start with the "),a("code",[e._v("commitRoot")]),e._v(" method. by using "),a("code",[e._v("rootFiber")]),e._v(" as the parameter. We already know that after "),a("code",[e._v("render")]),e._v(", it will go to the "),a("code",[e._v("commit")]),e._v(" stage, the path from "),a("code",[e._v("trigger update")]),e._v(" to "),a("code",[e._v("render")]),e._v(" should be look like")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("  trigger state update\n      |\n      |\n      v\n\n      ？\n\n      |\n      |\n      v\n\n  render（`performSyncWorkOnRoot` or `performConcurrentWorkOnRoot`）\n\n      |\n      |\n      v\n\n  commit（`commitRoot`）\n")])])])]),e._v(" "),a("li",[a("p",[e._v("create update object")]),e._v(" "),a("p",[e._v("In "),a("code",[e._v("React")]),e._v(", events could trigger state update including")]),e._v(" "),a("ul",[a("li",[e._v("ReactDOM.render")]),e._v(" "),a("li",[e._v("this.setState")]),e._v(" "),a("li",[e._v("this.forceUpdate")]),e._v(" "),a("li",[e._v("useState")]),e._v(" "),a("li",[e._v("useReducer")])]),e._v(" "),a("p",[e._v("How could these events use the same state update method?")]),e._v(" "),a("p",[e._v("The answer is, everytime when "),a("code",[e._v("state update")]),e._v(", an object which save the updateing related infos will be created, we named it "),a("code",[e._v("Update")]),e._v(". In the "),a("code",[e._v("beginWork")]),e._v(" of the "),a("code",[e._v("render")]),e._v(", "),a("code",[e._v("state")]),e._v(" will be recaculated based on the "),a("code",[e._v("Update")]),e._v(". We will dicuss "),a("code",[e._v("Update")]),e._v(" in the following chapter.")])]),e._v(" "),a("li",[a("p",[e._v("from fiber to root")]),e._v(" "),a("p",[e._v("Now we know that the "),a("code",[e._v("fiber which trigger state update")]),e._v(" includes "),a("code",[e._v("Update")]),e._v(" object.")]),e._v(" "),a("p",[a("code",[e._v("render")]),e._v(" stage start traversal from the top of "),a("code",[e._v("rootFiber")]),e._v(". The question is how could we get "),a("code",[e._v("rootFiber")]),e._v(" from the "),a("code",[e._v("fiber which trigger state update")]),e._v(".")]),e._v(" "),a("p",[e._v("I can tell you that we use "),a("code",[e._v("markUpdateLaneFromFiberToRoot")]),e._v(" method for implement it. "),a("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L636",target:"_blank",rel:"noopener noreferrer"}},[e._v("You can check the source code of "),a("code",[e._v("markUpdateLaneFromFiberToRoot")]),e._v(" from here."),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("The work have done here could be summarized as, traversal from the "),a("code",[e._v("fiber")]),e._v(" to the "),a("code",[e._v("rootFiber")]),e._v(" and return "),a("code",[e._v("rootFiber")]),e._v(".")])]),e._v(" "),a("li",[a("p",[e._v("update schedule")]),e._v(" "),a("p",[e._v("Now, we have a "),a("code",[e._v("rootFiber")]),e._v(" and the corresponding "),a("code",[e._v("Fiber tree")]),e._v(" includes a "),a("code",[e._v("Fiber node")]),e._v(" which has an "),a("code",[e._v("Update")]),e._v(".")]),e._v(" "),a("p",[e._v("Then, "),a("code",[e._v("Scheduler")]),e._v(" will decided if the update "),a("code",[e._v("synchronous")]),e._v(" or "),a("code",[e._v("asynchronous")]),e._v(" based on the priority of the "),a("code",[e._v("Upadte")]),e._v(".")]),e._v(" "),a("p",[a("code",[e._v("ensureRootIsScheduled")]),e._v(" is the method used here. Here is the core part of the "),a("code",[e._v("ensureRootIsScheduled")]),e._v(" method.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("newCallbackPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" SyncLanePriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// task expired，render synchronous.")]),e._v("\n  newCallbackNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("scheduleSyncCallback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performSyncWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("else")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// render based on the priority of the task asynchronous")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("var")]),e._v(" schedulerPriorityLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("lanePriorityToSchedulerPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("newCallbackPriority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  newCallbackNode "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("scheduleCallback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n    schedulerPriorityLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performConcurrentWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[a("a",{attrs:{href:"https://github.com/facebook/react/blob/b6df4417c79c11cfb44f965fab55b573882b1d54/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L602",target:"_blank",rel:"noopener noreferrer"}},[e._v("You can check the "),a("code",[e._v("ensureRootIsScheduled")]),e._v(" source code from here."),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("Besides, both "),a("code",[e._v("scheduleCallback")]),e._v(" and "),a("code",[e._v("scheduleSyncCallback")]),e._v(" will executed by the "),a("code",[e._v("priority")]),e._v(" by using the method provided by "),a("code",[e._v("Scheduler")]),e._v(". We can find the callback function here is")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performSyncWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("performConcurrentWorkOnRoot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("p",[e._v("This is the entry point of the "),a("code",[e._v("render")]),e._v(".")])])]),e._v(" "),a("h2",{attrs:{id:"conclusion"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[e._v("#")]),e._v(" Conclusion")]),e._v(" "),a("p",[e._v("Let's summary the whole path of the "),a("code",[e._v("state update")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("trigger state updates\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\ncreate Update object\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\nfrom fiber to root "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("markUpdateLaneFromFiberToRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\nupdate schedule "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("ensureRootIsScheduled"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\nrender "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performSyncWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" or "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("performConcurrentWorkOnRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("v")]),e._v("\n\ncommit "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("commitRoot"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("p",[e._v("We will discuss how "),a("code",[e._v("Update")]),e._v(" work in "),a("code",[e._v("React")]),e._v(" in the following article.")])])}),[],!1,null,null,null);t.default=n.exports}}]);